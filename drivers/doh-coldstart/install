#!/usr/bin/perl

use strict;
use warnings;
use Cwd;

# ---------------------------------------------------------------------------
# Global vars
# ---------------------------------------------------------------------------

use FindBin qw($RealBin);

my $current_dir = getcwd();

my $driver = "doh-coldstart";

my $source_dir = "../../local/doh-contracts"; # source dir with the template

my $run_build_sh = "run-build.sh";

my $local_prod_dir     = "../../local/prod/doh-contracts";
my $local_staging_dir  = "../../local/staging/doh-contracts";
my $local_dev_dir      = "../../local/dev/doh-contracts";

# ---------------------------------------------------------------------------
# Utils
# ---------------------------------------------------------------------------

# change to driver dir
sub chdir_driver_dir {
    chdir($RealBin) or die "ERROR: $driver: Failed to change working directory: $!";
}

sub chdir_prod_dir {
    chdir_driver_dir();     # absolute
    chdir $local_prod_dir;  # relative
    print "Current working directory: " . getcwd() .  "\n";
}

sub chdir_staging_dir {
    chdir_driver_dir();        # absolute
    chdir $local_staging_dir;  # relative
    print "Current working directory: " . getcwd() .  "\n";
}

sub chdir_dev_dir {
    chdir_driver_dir();    # absolute
    chdir $local_dev_dir;  # relative
    print "Current working directory: " . getcwd() .  "\n";
}

# target is prod, staging, dev
sub copy_doh {
    my $target = shift;
    die "ERROR: doh-coldstart: copy target not defined" unless (defined $target);

    my $destination = "../../local/$target/";

    my $to_remove = $destination . "doh-contracts";

    if (-d $to_remove) {
        system("rm -rf $destination") == 0 or die "ERROR: doh-coldstart: Error while trying to clear old local copy of doh_contracts for target $target ('rm -rf $to_remove'): $!";
    }
    system("mkdir -p $destination") == 0 or die "ERROR: doh-coldstart: Failed to create target directory $destination: $!";
    system("cp -r $source_dir $destination") == 0 or die "ERROR: doh-coldstart: Failed to copy $source_dir to $destination: $!";
}

# ---------------------------------------------------------------------------
# First, we need to download the DoH source code, since it is no longer
#   a submodule. This is done by tools/get-doh/get-doh.sh.
# ---------------------------------------------------------------------------

print "$driver: Downloading latest DoH source code to $source_dir using tools/get-doh.sh\n";

system("../../tools/get-doh/get-doh.sh $source_dir") == 0 or die "ERROR: doh-coldstart: Failed to get DoH source code: $!";

# ---------------------------------------------------------------------------
# The doh-contracts/ meta-submodule is a CODE TEMPLATE. It is not actual
#   source code for the DoH contracts suite. It has to be preprocessed for
#   ALL DoH targets, i.e. prod (hgm/tcn), staging (hg1/tc1) and dev (hg2/tc2),
#   to produce THREE different DoH contract suites that are specific to each
#   target.
#
# This installer will recompile ALL targets, FULLY. The build system as a
#   whole is not smart enough yet to save work. Run cth -i dummy and grab
#   a mug of coffee.
# ---------------------------------------------------------------------------

chdir_driver_dir();

print "$driver: Checking for doh-contracts at $source_dir\n";

if (-e "$source_dir/$run_build_sh") {
    print "$driver: DoH contracts found.\n";
} else {
    print "$driver: ERROR: DoH contracts not found in the expected tools directory path.\n";
    exit 1;
}

# ---------------------------------------------------------------------------
# Copy the tools/doh-contracts template to:
#   local/prod/doh-contracts/
#   local/staging/doh-contracts/
#   local/dev/doh-contracts/
# ---------------------------------------------------------------------------

print "$driver: Copying contract templates to local/ for all DoH targets ...\n";

copy_doh("prod");
copy_doh("staging");
copy_doh("dev");

# ---------------------------------------------------------------------------
# And then run:
#   local/prod/doh-contracts/set-prod.sh
#   local/staging/doh-contracts/set-staging.sh
#   local/dev/doh-contracts/set-dev.sh
# ---------------------------------------------------------------------------

print "$driver: Instantiating contract templates on local/ for all DoH targets ...\n";

chdir_prod_dir();
system("set-prod.sh") == 0 or die "ERROR: $driver: Failed to create prod contracts: $!";

chdir_staging_dir();
system("set-staging.sh") == 0 or die "ERROR: $driver: Failed to create staging contracts: $!";

chdir_dev_dir();
system("set-dev.sh") == 0 or die "ERROR: $driver: Failed to create dev contracts: $!";

# ---------------------------------------------------------------------------
# And then run:
#   local/prod/doh-contracts/run-build.sh
#   local/staging/doh-contracts/run-build.sh
#   local/dev/doh-contracts/run-build.sh
# ---------------------------------------------------------------------------

my $ret;

print "$driver: Running DoH contracts build script for prod...\n";
chdir_prod_dir();
$ret = system($run_build_sh);
if ($ret == 0) {
    print "$driver: DoH contracts built successfully at $local_prod_dir\n";
} else {
    my $exit_code = $ret >> 8;
    print "$driver: ERROR: DoH contracts build failed. system() returned: $ret, exit code: $exit_code.\n";
    exit 1;
}

print "$driver: Running DoH contracts build script for staging...\n";
chdir_staging_dir();
$ret = system($run_build_sh);
if ($ret == 0) {
    print "$driver: DoH contracts built successfully at $local_staging_dir\n";
} else {
    my $exit_code = $ret >> 8;
    print "$driver: ERROR: DoH contracts build failed. system() returned: $ret, exit code: $exit_code.\n";
    exit 1;
}

print "$driver: Running DoH contracts build script for dev...\n";
chdir_dev_dir();
$ret = system($run_build_sh);
if ($ret == 0) {
    print "$driver: DoH contracts built successfully at $local_dev_dir\n";
} else {
    my $exit_code = $ret >> 8;
    print "$driver: ERROR: DoH contracts build failed. system() returned: $ret, exit code: $exit_code.\n";
    exit 1;
}

